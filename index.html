<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <title>아르테크 — 모바일 전용 샘플</title>
  <style>
    :root { --bg:#0b1220; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#38bdf8; }
    *{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Apple SD Gothic Neo","Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .wrap{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:440px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:24px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .pad{padding:20px}
    h1{font-size:20px;margin:0 0 6px}
    p{margin:8px 0;color:var(--muted);line-height:1.5}
    button,input[type=file]{appearance:none;border:0;border-radius:14px;padding:14px 16px;background:var(--accent);color:#06121a;font-weight:700;cursor:pointer; display: block; margin: 0 auto;}
    .row{display:flex;gap:12px;align-items:center}
    .hidden{display:none !important}
    .notice{padding:16px;border-radius:14px;background:#181f2f;border:1px solid rgba(255,255,255,.06);color:var(--text)}
    .qr{width:140px;height:140px;border-radius:12px;background:conic-gradient(from 90deg,#111 0 25%,#222 0 50%,#111 0 75%,#222 0);display:flex;align-items:center;justify-content:center;color:#fff;opacity:.75}
    .footer{margin-top:16px;color:var(--muted);font-size:12px;text-align:center}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);margin:16px 0}
    .ghost{opacity:.55}
  </style>
</head>
<body>
  <div id="app" class="wrap">
    <div class="card">
      <div class="pad">
        <h1>아르테크 — 모바일 전용 샘플</h1>
        <p class="ghost">골동품 이미지를 업로드하면 AI 1차 감정 결과 요약을 보여주는 데모 화면입니다.</p>
        <div class="divider"></div>

        <!-- Desktop/Large-screen lock -->
        <div id="desktopLock" class="notice hidden">
          <p style="font-weight:700">이 서비스는 모바일 전용입니다 📱</p>
          <p>스마트폰으로 아래 주소를 열어 접속하세요.</p>
          <div class="row" style="margin:12px 0;justify-content:space-between">
            <div>
              <p class="ghost" style="margin:0">현재 페이지 URL</p>
              <p id="pageUrl" style="word-break:break-all"></p>
            </div>
            <div class="qr" aria-hidden="true">QR</div>
          </div>
          <p class="footer">※ 개발·심사용으로 PC에서 확인이 필요하면 <code>?allowDesktop=1</code> 또는 <code>#force</code> 를 URL 뒤에 붙이세요.</p>
        </div>

        <!-- Mobile UI -->
        <div id="mobileUI" class="hidden">
          <p style="margin-top:0">샘플 입력</p>
          <div style="text-align:center">
            <input id="file" type="file" accept="image/*" capture="environment" />
          </div>
          <div id="preview" style="margin-top:12px"></div>
          <div class="divider"></div>
          <p style="margin:8px 0 6px">🔎 내 DB에서 찾기</p>
          <div class="row" style="gap:8px">
            <input id="q" type="text" placeholder="키워드/작품번호 검색 (예: 백자, 청자, J-2023-001)" style="flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#0f172a;color:var(--text)"/>
            <button id="btnSearch" type="button">검색</button>
          </div>
          <div id="searchInfo" class="ghost" style="font-size:12px;margin-top:6px">레포 루트에 <code>db.json</code> 파일을 두면 자동으로 불러옵니다.</div>
          <div id="list" style="margin-top:12px"></div>
          <div id="result" class="notice hidden" style="margin-top:12px"></div>
        </div>

        <div class="footer">© Artech — demo</div>
      </div>
    </div>
  </div>

  <script>
    // --- Mobile-only gate (client side) ---
    (function(){
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      // Include KakaoTalk / Kakao Browser signatures
      const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|KAKAOTALK|KAKAOBROWSER/i.test(ua);
      const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      const smallScreen = Math.min(window.innerWidth, window.innerHeight) <= 1024;
      const url = new URL(window.location.href);
      const allowDesktop = url.searchParams.get('allowDesktop') === '1' || url.hash.includes('force');

      const mobileUI = document.getElementById('mobileUI');
      const desktopLock = document.getElementById('desktopLock');
      document.getElementById('pageUrl').textContent = window.location.href.split('?')[0];

      const pass = ((isMobileUA || hasTouch) && smallScreen) || allowDesktop;
      if(pass){ mobileUI.classList.remove('hidden'); }
      else { desktopLock.classList.remove('hidden'); }

      // Debug panel to inspect detection states
      if (url.hash.includes('debug')) {
        const dbg = document.createElement('pre');
        dbg.style.padding='12px';
        dbg.style.background='#0f172a';
        dbg.style.border='1px solid rgba(255,255,255,.08)';
        dbg.style.borderRadius='12px';
        dbg.style.marginTop='12px';
        dbg.textContent = [
          `UA: ${ua}`,
          `isMobileUA: ${isMobileUA}`,
          `hasTouch: ${hasTouch}`,
          `smallScreen: ${smallScreen} (${window.innerWidth}x${window.innerHeight})`,
          `allowDesktop: ${allowDesktop}`,
          `PASS: ${pass}`
        ].join('\n');
        document.querySelector('.pad').appendChild(dbg);
      }
    })();

    // --- Very lightweight demo logic ---
    (function(){
      const fileInput = document.getElementById('file');
      const preview = document.getElementById('preview');
      const result = document.getElementById('result');
      if(!fileInput) return;

      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        // show preview
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.alt = '업로드 이미지 미리보기';
        img.style.maxWidth = '100%';
        img.style.borderRadius = '14px';
        img.onload = () => URL.revokeObjectURL(img.src);
        preview.innerHTML = '';
        preview.appendChild(img);

        // 1) 파일명(확장자 제외)으로 DB 자동검색 시도
        const base = (file.name || '').split('.')[0];
        if (window.searchDBThenRender && window.searchDBThenRender(base)) {
          // 매칭되어 DB 결과가 그려졌으므로 여기서 끝!
          return;
        }

        // 2) 매칭 실패 시에만 샘플 문구 표시 (fallback)
        result.classList.remove('hidden');
        result.innerHTML = '<strong>AI 1차 감정(샘플)</strong><br>• 유형: 도자기(추정)<br>• 시대: 조선 후기(추정)<br>• 유사 사례: 3건 매칭<br><span class="ghost">※ 데모 텍스트 — 추후 실제 모델 연동</span>';
      });
    })();
  </script>
  <script>
    // --- Lightweight DB search module ---
    (function(){
      const fileInput = document.getElementById('file');
      const preview   = document.getElementById('preview');
      const result    = document.getElementById('result');
      const q         = document.getElementById('q');
      const btnSearch = document.getElementById('btnSearch');
      const list      = document.getElementById('list');
      const searchInfo= document.getElementById('searchInfo');
      if(!q || !btnSearch) return;

      let DB = [];
      // 1) db.json 로드 (루트에 두면 ./db.json 경로)
      fetch('./db.json', {cache:'no-store'})
        .then(r => r.ok ? r.json() : [])
        .then(json => {
          DB = Array.isArray(json) ? json : (json.items || []);
          if(DB.length){ searchInfo.textContent = `DB 로드됨: ${DB.length}건`; }
        })
        .catch(()=>{ searchInfo.textContent = 'db.json을 찾지 못했습니다. (선택사항)'; });

      // 렌더링 유틸
      function renderItem(it){
        result.classList.remove('hidden');
        result.innerHTML = `
          <strong>${it.name||'제목 없음'}</strong><br>
          • 유형: ${it.type||'-'}<br>
          • 시대/연대: ${it.era||'-'}<br>
          • 소장번호: ${it.code||'-'}<br>
          <div style="margin-top:8px">${(it.desc||'').replace(/\n/g,'<br>')}</div>
          ${it.images && it.images.length
            ? `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
                ${it.images.slice(0,4).map(src=>`<img src="${src}" alt="ref" style="width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.1)">`).join('')}
              </div>`
            : '' }
        `;
      }
      function renderList(items){
        list.innerHTML = '';
        if(!items.length){ list.innerHTML = '<p class="ghost">검색 결과가 없습니다.</p>'; return; }
        const frag = document.createDocumentFragment();
        items.slice(0,20).forEach(it => {
          const card = document.createElement('div');
          card.className = 'notice';
          card.style.cursor = 'pointer';
          card.style.marginTop = '8px';
          card.innerHTML = `<div style="display:flex;align-items:center;gap:10px">
            ${it.thumbnail ? `<img src="${it.thumbnail}" alt="thumb" style="width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.1)">` : ''}
            <div>
              <div style="font-weight:700">${it.name||'(제목 없음)'}</div>
              <div class="ghost" style="font-size:12px">${[it.code,it.type,it.era].filter(Boolean).join(' · ')}</div>
            </div>
          </div>`;
          card.addEventListener('click',()=> renderItem(it));
          frag.appendChild(card);
        });
        list.appendChild(frag);
      }
      function searchDB(keyword){
        const kw = (keyword||'').trim().toLowerCase();
        if(!kw){ list.innerHTML = '<p class="ghost">검색어를 입력하세요.</p>'; return; }
        const items = DB.filter(it => {
          const hay = `${it.name||''} ${it.type||''} ${it.era||''} ${it.code||''} ${it.desc||''}`.toLowerCase();
          return kw.split(/\s+/).every(k => hay.includes(k));
        });
        renderList(items);
      }

      btnSearch.addEventListener('click', ()=> searchDB(q.value));
      q.addEventListener('keydown', e => { if(e.key==='Enter') searchDB(q.value); });

      // 이미지 업로드 시 파일명으로 자동 검색(선택)
      fileInput?.addEventListener('change', e => {
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.alt = '업로드 이미지 미리보기';
        img.style.maxWidth = '100%';
        img.style.borderRadius = '14px';
        img.onload = () => URL.revokeObjectURL(img.src);
        preview.innerHTML = '';
        preview.appendChild(img);

        const base = (file.name||'').split('.')[0];
        if(DB.length && base){ searchDB(base); }
      });
    })();
    window.searchDBThenRender = (kw) => {
      const keyword = (kw||'').trim().toLowerCase();
      if(!keyword) return false;
      const items = DB.filter(it => {
        const hay = `${it.name||''} ${it.type||''} ${it.era||''} ${it.code||''} ${it.desc||''}`.toLowerCase();
        return keyword.split(/\s+/).every(k => hay.includes(k));
      });
      if(items.length){
        renderList(items);
        // 첫 항목 상세를 바로 출력(원하면 클릭 유도만 하고 싶으면 이 줄을 빼도 됨)
        renderItem(items[0]);
        return true; // 찾았다!
      }
      return false; // 못 찾았다
    };
  </script>
</body>
</html>
